<?php

$url = "https://pentester.land/writeups.json";

$response = file_get_contents($url);

if ($response === FALSE) {
    die('Error occurred while fetching data.');
}

$newData = json_decode($response, true);

$oldDataFile = 'writeups.json';
if (file_exists($oldDataFile)) {
    $oldData = json_decode(file_get_contents($oldDataFile), true);
} else {
    $oldData = ['data' => []];
}

$newEntries = array_filter($newData['data'], function ($newEntry) use ($oldData) {
    foreach ($oldData['data'] as $oldEntry) {
        if ($newEntry['PublicationDate'] === $oldEntry['PublicationDate'] && $newEntry['Links'][0]['Link'] === $oldEntry['Links'][0]['Link']) {
            return false;
        }
    }
    return true;
});

if (count($newEntries) > 0) {
    echo "New entries found.\n";
    
    $botToken = "TELEGRAM_BOT_TOKEN";
    $chatId = "CHANNEL_OR_GROUP_OR_USER_ID";
    
    foreach ($newEntries as $entry) {
        $title = htmlspecialchars($entry['Links'][0]['Title']);
        $author = htmlspecialchars($entry['Authors'][0]);
        $link = htmlspecialchars($entry['Links'][0]['Link']);
        $programs = implode(', ', array_map(function($program) {
            return '#' . str_replace(' ', '', $program);
        }, $entry['Programs']));
        $bugs = implode(', ', array_map(function($bug) {
            return '#' . str_replace(' ', '', $bug);
        }, $entry['Bugs']));
        
        $message = "<b>$title</b>\n";
        $message .= "$author\n";
        $message .= "<a href=\"$link\">Link</a>\n\n";
        $message .= "$programs\n";
        $message .= "$bugs";
        
        file_get_contents("https://api.telegram.org/bot$botToken/sendMessage?chat_id=$chatId&text=" . urlencode($message) . "&parse_mode=HTML");
    }
    
    file_put_contents($oldDataFile, json_encode($newData));
    echo "True";
} else {
    echo "False";
}
?>
